# CAKE Traffic Shaping Configuration Example
# Copy this to your .env file and adjust values as needed

#############################################
# GLOBAL CAKE CONFIGURATION
#############################################

# Enable or disable CAKE traffic shaping globally
# Set to "true" to enable, "false" to disable
# Default: false
CAKE_ENABLED=true

#############################################
# PER-ZONE BANDWIDTH LIMITS
#############################################

# ADMINS Zone - Full-speed access for administrators
# Recommended: Set to 90-95% of your link speed
# Examples: 1gbit, 950mbit, 100mbit, 50mbit
CAKE_BANDWIDTH_ADMINS=1gbit

# MEMBERS Zone - Standard user access
# Recommended: 50-200 Mbit/s for typical users
CAKE_BANDWIDTH_MEMBERS=100mbit

# GUESTS Zone - Limited access for guest users
# Recommended: 25-100 Mbit/s for guests
CAKE_BANDWIDTH_GUESTS=50mbit

# LANP2P Zone - LAN-only peer-to-peer connections
# Recommended: Match or exceed local network speed
CAKE_BANDWIDTH_LANP2P=100mbit

#############################################
# ADVANCED CAKE PARAMETERS
#############################################

# Overhead compensation (bytes added to each packet)
# Use this if you have encapsulation overhead (PPPoE, ATM, etc.)
#
# Common values:
# - 0: No overhead (default, Ethernet)
# - 18: PPPoE (PPPoE header 8 bytes + Ethernet 10 bytes)
# - 22: PPPoE on ATM
# - 44: ATM (ADSL)
#
# Range: -64 to 256
# Default: 0
CAKE_OVERHEAD=0

# Minimum packet unit (rounds packet size up to this value)
# Useful for links that pad small packets
#
# Range: 0 to 256
# Default: 0
CAKE_MPU=0

# Memory limit for CAKE queues
# More memory = larger queues = more buffering = potentially higher latency
# Less memory = smaller queues = less buffering = lower latency
#
# Recommendations:
# - Low latency (gaming, VoIP): 8m or 16m
# - Balanced (general use): 32m (default)
# - High throughput (large transfers): 64m or 128m
#
# Default: 32m
CAKE_MEMLIMIT=32m

# CAKE options (space-separated list)
#
# Available options:
# - besteffort: Single queue mode (no priority) - RECOMMENDED for VPN
# - diffserv4: 4-tier priority queuing based on DSCP (Bulk, BestEffort, Video, Voice)
# - diffserv8: 8-tier priority queuing
# - triple-isolate: Fair queuing per-host and per-flow through NAT - RECOMMENDED
# - dual-srchost: Fair queuing per source host
# - dual-dsthost: Fair queuing per destination host
# - nat: Enable NAT awareness - RECOMMENDED for VPN
# - nonat: Disable NAT awareness
# - wash: Clear DSCP markings
# - nowash: Preserve DSCP markings - RECOMMENDED
# - split-gso: Split GSO packets for accurate shaping - RECOMMENDED
# - no-split-gso: Don't split GSO packets
# - ack-filter: Filter redundant TCP ACKs - OPTIONAL for asymmetric links
# - ack-filter-aggressive: More aggressive ACK filtering
# - no-ack-filter: Disable ACK filtering (default)
# - autorate-ingress: Automatic rate adaptation - OPTIONAL for variable bandwidth
# - ingress: Ingress mode
# - ethernet: Ethernet framing (default)
# - atm: ATM framing (for ADSL)
# - ptm: PTM framing
# - docsis: DOCSIS cable modem framing
#
# Default (recommended for most VPN scenarios):
CAKE_OPTIONS="besteffort triple-isolate nat nowash split-gso"

# Alternative configurations:

# For asymmetric links (e.g., cable modem 200/10 Mbps):
# CAKE_OPTIONS="besteffort triple-isolate nat nowash split-gso ack-filter-aggressive"

# For variable bandwidth (e.g., cellular, satellite):
# CAKE_OPTIONS="besteffort triple-isolate nat nowash split-gso autorate-ingress"

# For priority-aware shaping with DSCP markings:
# CAKE_OPTIONS="diffserv4 triple-isolate nat nowash split-gso"

# For ADSL with ATM framing:
# CAKE_OPTIONS="besteffort triple-isolate nat nowash split-gso atm"
# CAKE_OVERHEAD=44

# For PPPoE connections:
# CAKE_OPTIONS="besteffort triple-isolate nat nowash split-gso"
# CAKE_OVERHEAD=18

#############################################
# USAGE EXAMPLES
#############################################

# Example 1: Home server with 1 Gbps symmetric fiber
# CAKE_ENABLED=true
# CAKE_BANDWIDTH_ADMINS=950mbit
# CAKE_BANDWIDTH_MEMBERS=200mbit
# CAKE_BANDWIDTH_GUESTS=50mbit
# CAKE_OVERHEAD=0
# CAKE_OPTIONS="besteffort triple-isolate nat nowash split-gso"

# Example 2: Small office with 100 Mbps cable (asymmetric)
# CAKE_ENABLED=true
# CAKE_BANDWIDTH_ADMINS=95mbit
# CAKE_BANDWIDTH_MEMBERS=50mbit
# CAKE_BANDWIDTH_GUESTS=25mbit
# CAKE_OVERHEAD=0
# CAKE_OPTIONS="besteffort triple-isolate nat nowash split-gso ack-filter"

# Example 3: Low-latency gaming server
# CAKE_ENABLED=true
# CAKE_BANDWIDTH_ADMINS=950mbit
# CAKE_BANDWIDTH_MEMBERS=100mbit
# CAKE_BANDWIDTH_GUESTS=50mbit
# CAKE_MEMLIMIT=16m
# CAKE_OPTIONS="besteffort triple-isolate nat nowash split-gso"

# Example 4: High-throughput download server
# CAKE_ENABLED=true
# CAKE_BANDWIDTH_ADMINS=950mbit
# CAKE_BANDWIDTH_MEMBERS=500mbit
# CAKE_BANDWIDTH_GUESTS=100mbit
# CAKE_MEMLIMIT=64m
# CAKE_OPTIONS="besteffort triple-isolate nat nowash split-gso"

# Example 5: ADSL connection (25 Mbps down, 5 Mbps up)
# CAKE_ENABLED=true
# CAKE_BANDWIDTH_ADMINS=4750kbit
# CAKE_BANDWIDTH_MEMBERS=23750kbit
# CAKE_BANDWIDTH_GUESTS=11875kbit
# CAKE_OVERHEAD=44
# CAKE_OPTIONS="besteffort triple-isolate nat nowash split-gso atm"

#############################################
# TESTING AND VALIDATION
#############################################

# After applying configuration, verify CAKE is working:
#
# 1. Enter the container:
#    docker exec -it wiregate bash
#
# 2. Check CAKE status:
#    tc qdisc show dev MEMBERS
#
# 3. Check detailed statistics:
#    tc -s qdisc show dev MEMBERS
#
# 4. Test latency under load (from client):
#    ping wiregate-server
#    # In another terminal, run a large download
#    # Ping should stay low (< 20ms) with CAKE enabled
#
# 5. Check for packet drops:
#    tc -s qdisc show dev MEMBERS | grep dropped
#    # Some drops are normal; excessive drops mean bandwidth is too low

#############################################
# PERFORMANCE TUNING TIPS
#############################################

# 1. Set bandwidth to 90-95% of actual link speed for best bufferbloat control
# 2. Use smaller CAKE_MEMLIMIT (8m-16m) for low-latency applications
# 3. Use larger CAKE_MEMLIMIT (64m-128m) for high-throughput applications
# 4. Enable ack-filter for asymmetric connections (upload much slower than download)
# 5. Enable autorate-ingress for variable bandwidth connections
# 6. Monitor tc statistics regularly to check for drops and overlimits
# 7. Adjust bandwidth if you see excessive packet drops

#############################################
# TROUBLESHOOTING
#############################################

# If CAKE is not working:
#
# 1. Check if CAKE is enabled:
#    echo $CAKE_ENABLED
#
# 2. Check container logs:
#    docker logs wiregate | grep CAKE
#
# 3. Verify tc command is available:
#    docker exec -it wiregate tc -help | grep cake
#
# 4. Check kernel module (on host):
#    lsmod | grep sch_cake
#    # If not loaded, try: modprobe sch_cake
#
# 5. Verify interface is up:
#    docker exec -it wiregate ip link show MEMBERS
#
# For more help, see: docs/CAKE_TRAFFIC_SHAPING.md
