# ModSecurity Exclusion Rules for API Endpoints
# This file should be included in your ModSecurity configuration
# to allow legitimate API operations that might trigger false positives.
#
# IMPORTANT: This file must be included BEFORE the CRS rules
# In modsecurity.conf, add this line BEFORE the CRS includes:
# Include /etc/nginx/modsecurity/api-exclusions.conf

# =============================================================================
# Tor Configuration Update API Exclusions
# =============================================================================
# The /api/tor/config/update endpoint accepts Tor configuration file content
# which may contain legitimate patterns that trigger ModSecurity rules:
# - File paths (var/log, etc.) - triggers LFI detection (930120)
# - Shell-like commands - triggers RCE detection (932235)
# - Multi-line configuration content - may trigger other rules
# =============================================================================

# Rule 1: Exclude LFI detection for Tor config update endpoint
# Tor configs legitimately contain file paths like "var/log"
SecRule REQUEST_URI "@beginsWith /api/tor/config/update" \
    "id:1000101,\
    phase:1,\
    t:none,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=930120,\
    ctl:ruleRemoveByTag=attack-lfi,\
    msg:'Tor config update - LFI exclusion'"

# Rule 2: Exclude RCE detection for Tor config update endpoint
# Tor configs contain shell-like commands that are legitimate configuration
SecRule REQUEST_URI "@beginsWith /api/tor/config/update" \
    "id:1000102,\
    phase:1,\
    t:none,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=932235,\
    ctl:ruleRemoveByTag=attack-rce,\
    msg:'Tor config update - RCE exclusion'"

# Rule 3: Exclude rules from ARGS:json.content specifically
# This is more targeted - only exclude when checking the json.content parameter
SecRule REQUEST_URI "@beginsWith /api/tor/config/update" \
    "id:1000103,\
    phase:2,\
    t:none,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=930120;ARGS:json.content,\
    ctl:ruleRemoveTargetById=932235;ARGS:json.content,\
    msg:'Tor config update - argument-specific exclusion'"

# Rule 4: Additional exclusion for common false positives in config content
# Exclude rules that commonly trigger on configuration file content
SecRule REQUEST_URI "@beginsWith /api/tor/config/update" \
    "id:1000104,\
    phase:2,\
    t:none,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941000,\
    ctl:ruleRemoveById=942000,\
    ctl:ruleRemoveById=943000,\
    ctl:ruleRemoveById=949000,\
    msg:'Tor config update - additional rule exclusions'"

# =============================================================================
# Additional API Endpoint Exclusions (if needed)
# =============================================================================
# Add more exclusions here for other API endpoints that have false positives

# Example: WireGuard Configuration Updates
# WireGuard configs also contain file paths and shell commands
# Uncomment if you experience similar issues with WireGuard config updates
#
# SecRule REQUEST_URI "@rx ^/api/(updateConfiguration|addPeers)" \
#     "id:1000201,\
#     phase:1,\
#     t:none,\
#     pass,\
#     nolog,\
#     ctl:ruleRemoveById=930120,\
#     ctl:ruleRemoveById=932235,\
#     msg:'WireGuard config update exclusions'"

